{"ast":null,"code":"var ClientConstants = require('../constants/client');\n\nvar fs = require('fs');\n\nvar Packets = require('../packets');\n\nvar ResultSet = require('../ResultSet');\n\nvar Sequence = require('./Sequence');\n\nvar ServerStatus = require('../constants/server_status');\n\nvar Readable = require('readable-stream');\n\nvar Util = require('util');\n\nmodule.exports = Query;\nUtil.inherits(Query, Sequence);\n\nfunction Query(options, callback) {\n  Sequence.call(this, options, callback);\n  this.sql = options.sql;\n  this.values = options.values;\n  this.typeCast = options.typeCast === undefined ? true : options.typeCast;\n  this.nestTables = options.nestTables || false;\n  this._resultSet = null;\n  this._results = [];\n  this._fields = [];\n  this._index = 0;\n  this._loadError = null;\n}\n\nQuery.prototype.start = function () {\n  this.emit('packet', new Packets.ComQueryPacket(this.sql));\n};\n\nQuery.prototype.determinePacket = function determinePacket(byte, parser) {\n  var resultSet = this._resultSet;\n\n  if (!resultSet) {\n    switch (byte) {\n      case 0x00:\n        return Packets.OkPacket;\n\n      case 0xfb:\n        return Packets.LocalInfileRequestPacket;\n\n      case 0xff:\n        return Packets.ErrorPacket;\n\n      default:\n        return Packets.ResultSetHeaderPacket;\n    }\n  }\n\n  if (resultSet.eofPackets.length === 0) {\n    return resultSet.fieldPackets.length < resultSet.resultSetHeaderPacket.fieldCount ? Packets.FieldPacket : Packets.EofPacket;\n  }\n\n  if (byte === 0xff) {\n    return Packets.ErrorPacket;\n  }\n\n  if (byte === 0xfe && parser.packetLength() < 9) {\n    return Packets.EofPacket;\n  }\n\n  return Packets.RowDataPacket;\n};\n\nQuery.prototype['OkPacket'] = function (packet) {\n  // try...finally for exception safety\n  try {\n    if (!this._callback) {\n      this.emit('result', packet, this._index);\n    } else {\n      this._results.push(packet);\n\n      this._fields.push(undefined);\n    }\n  } finally {\n    this._index++;\n    this._resultSet = null;\n\n    this._handleFinalResultPacket(packet);\n  }\n};\n\nQuery.prototype['ErrorPacket'] = function (packet) {\n  var err = this._packetToError(packet);\n\n  var results = this._results.length > 0 ? this._results : undefined;\n  var fields = this._fields.length > 0 ? this._fields : undefined;\n  err.index = this._index;\n  err.sql = this.sql;\n  this.end(err, results, fields);\n};\n\nQuery.prototype['LocalInfileRequestPacket'] = function (packet) {\n  if (this._connection.config.clientFlags & ClientConstants.CLIENT_LOCAL_FILES) {\n    this._sendLocalDataFile(packet.filename);\n  } else {\n    this._loadError = new Error('Load local files command is disabled');\n    this._loadError.code = 'LOCAL_FILES_DISABLED';\n    this._loadError.fatal = false;\n    this.emit('packet', new Packets.EmptyPacket());\n  }\n};\n\nQuery.prototype['ResultSetHeaderPacket'] = function (packet) {\n  this._resultSet = new ResultSet(packet);\n};\n\nQuery.prototype['FieldPacket'] = function (packet) {\n  this._resultSet.fieldPackets.push(packet);\n};\n\nQuery.prototype['EofPacket'] = function (packet) {\n  this._resultSet.eofPackets.push(packet);\n\n  if (this._resultSet.eofPackets.length === 1 && !this._callback) {\n    this.emit('fields', this._resultSet.fieldPackets, this._index);\n  }\n\n  if (this._resultSet.eofPackets.length !== 2) {\n    return;\n  }\n\n  if (this._callback) {\n    this._results.push(this._resultSet.rows);\n\n    this._fields.push(this._resultSet.fieldPackets);\n  }\n\n  this._index++;\n  this._resultSet = null;\n\n  this._handleFinalResultPacket(packet);\n};\n\nQuery.prototype._handleFinalResultPacket = function (packet) {\n  if (packet.serverStatus & ServerStatus.SERVER_MORE_RESULTS_EXISTS) {\n    return;\n  }\n\n  var results = this._results.length > 1 ? this._results : this._results[0];\n  var fields = this._fields.length > 1 ? this._fields : this._fields[0];\n  this.end(this._loadError, results, fields);\n};\n\nQuery.prototype['RowDataPacket'] = function (packet, parser, connection) {\n  packet.parse(parser, this._resultSet.fieldPackets, this.typeCast, this.nestTables, connection);\n\n  if (this._callback) {\n    this._resultSet.rows.push(packet);\n  } else {\n    this.emit('result', packet, this._index);\n  }\n};\n\nQuery.prototype._sendLocalDataFile = function (path) {\n  var self = this;\n  var localStream = fs.createReadStream(path, {\n    flag: 'r',\n    encoding: null,\n    autoClose: true\n  });\n  this.on('pause', function () {\n    localStream.pause();\n  });\n  this.on('resume', function () {\n    localStream.resume();\n  });\n  localStream.on('data', function (data) {\n    self.emit('packet', new Packets.LocalDataFilePacket(data));\n  });\n  localStream.on('error', function (err) {\n    self._loadError = err;\n    localStream.emit('end');\n  });\n  localStream.on('end', function () {\n    self.emit('packet', new Packets.EmptyPacket());\n  });\n};\n\nQuery.prototype.stream = function (options) {\n  var self = this;\n  options = options || {};\n  options.objectMode = true;\n  var stream = new Readable(options);\n\n  stream._read = function () {\n    self._connection && self._connection.resume();\n  };\n\n  stream.once('end', function () {\n    process.nextTick(function () {\n      stream.emit('close');\n    });\n  });\n  this.on('result', function (row, i) {\n    if (!stream.push(row)) self._connection.pause();\n    stream.emit('result', row, i); // replicate old emitter\n  });\n  this.on('error', function (err) {\n    stream.emit('error', err); // Pass on any errors\n  });\n  this.on('end', function () {\n    stream.push(null); // pushing null, indicating EOF\n  });\n  this.on('fields', function (fields, i) {\n    stream.emit('fields', fields, i); // replicate old emitter\n  });\n  return stream;\n};","map":{"version":3,"sources":["/home/joe/DISSY/flask_test_1/react-flask-app/node_modules/mysql/lib/protocol/sequences/Query.js"],"names":["ClientConstants","require","fs","Packets","ResultSet","Sequence","ServerStatus","Readable","Util","module","exports","Query","inherits","options","callback","call","sql","values","typeCast","undefined","nestTables","_resultSet","_results","_fields","_index","_loadError","prototype","start","emit","ComQueryPacket","determinePacket","byte","parser","resultSet","OkPacket","LocalInfileRequestPacket","ErrorPacket","ResultSetHeaderPacket","eofPackets","length","fieldPackets","resultSetHeaderPacket","fieldCount","FieldPacket","EofPacket","packetLength","RowDataPacket","packet","_callback","push","_handleFinalResultPacket","err","_packetToError","results","fields","index","end","_connection","config","clientFlags","CLIENT_LOCAL_FILES","_sendLocalDataFile","filename","Error","code","fatal","EmptyPacket","rows","serverStatus","SERVER_MORE_RESULTS_EXISTS","connection","parse","path","self","localStream","createReadStream","flag","encoding","autoClose","on","pause","resume","data","LocalDataFilePacket","stream","objectMode","_read","once","process","nextTick","row","i"],"mappings":"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","sourcesContent":["var ClientConstants = require('../constants/client');\nvar fs              = require('fs');\nvar Packets         = require('../packets');\nvar ResultSet       = require('../ResultSet');\nvar Sequence        = require('./Sequence');\nvar ServerStatus    = require('../constants/server_status');\nvar Readable        = require('readable-stream');\nvar Util            = require('util');\n\nmodule.exports = Query;\nUtil.inherits(Query, Sequence);\nfunction Query(options, callback) {\n  Sequence.call(this, options, callback);\n\n  this.sql = options.sql;\n  this.values = options.values;\n  this.typeCast = (options.typeCast === undefined)\n    ? true\n    : options.typeCast;\n  this.nestTables = options.nestTables || false;\n\n  this._resultSet = null;\n  this._results   = [];\n  this._fields    = [];\n  this._index     = 0;\n  this._loadError = null;\n}\n\nQuery.prototype.start = function() {\n  this.emit('packet', new Packets.ComQueryPacket(this.sql));\n};\n\nQuery.prototype.determinePacket = function determinePacket(byte, parser) {\n  var resultSet = this._resultSet;\n\n  if (!resultSet) {\n    switch (byte) {\n      case 0x00: return Packets.OkPacket;\n      case 0xfb: return Packets.LocalInfileRequestPacket;\n      case 0xff: return Packets.ErrorPacket;\n      default:   return Packets.ResultSetHeaderPacket;\n    }\n  }\n\n  if (resultSet.eofPackets.length === 0) {\n    return (resultSet.fieldPackets.length < resultSet.resultSetHeaderPacket.fieldCount)\n      ? Packets.FieldPacket\n      : Packets.EofPacket;\n  }\n\n  if (byte === 0xff) {\n    return Packets.ErrorPacket;\n  }\n\n  if (byte === 0xfe && parser.packetLength() < 9) {\n    return Packets.EofPacket;\n  }\n\n  return Packets.RowDataPacket;\n};\n\nQuery.prototype['OkPacket'] = function(packet) {\n  // try...finally for exception safety\n  try {\n    if (!this._callback) {\n      this.emit('result', packet, this._index);\n    } else {\n      this._results.push(packet);\n      this._fields.push(undefined);\n    }\n  } finally {\n    this._index++;\n    this._resultSet = null;\n    this._handleFinalResultPacket(packet);\n  }\n};\n\nQuery.prototype['ErrorPacket'] = function(packet) {\n  var err = this._packetToError(packet);\n\n  var results = (this._results.length > 0)\n    ? this._results\n    : undefined;\n\n  var fields = (this._fields.length > 0)\n    ? this._fields\n    : undefined;\n\n  err.index = this._index;\n  err.sql   = this.sql;\n\n  this.end(err, results, fields);\n};\n\nQuery.prototype['LocalInfileRequestPacket'] = function(packet) {\n  if (this._connection.config.clientFlags & ClientConstants.CLIENT_LOCAL_FILES) {\n    this._sendLocalDataFile(packet.filename);\n  } else {\n    this._loadError       = new Error('Load local files command is disabled');\n    this._loadError.code  = 'LOCAL_FILES_DISABLED';\n    this._loadError.fatal = false;\n\n    this.emit('packet', new Packets.EmptyPacket());\n  }\n};\n\nQuery.prototype['ResultSetHeaderPacket'] = function(packet) {\n  this._resultSet = new ResultSet(packet);\n};\n\nQuery.prototype['FieldPacket'] = function(packet) {\n  this._resultSet.fieldPackets.push(packet);\n};\n\nQuery.prototype['EofPacket'] = function(packet) {\n  this._resultSet.eofPackets.push(packet);\n\n  if (this._resultSet.eofPackets.length === 1 && !this._callback) {\n    this.emit('fields', this._resultSet.fieldPackets, this._index);\n  }\n\n  if (this._resultSet.eofPackets.length !== 2) {\n    return;\n  }\n\n  if (this._callback) {\n    this._results.push(this._resultSet.rows);\n    this._fields.push(this._resultSet.fieldPackets);\n  }\n\n  this._index++;\n  this._resultSet = null;\n  this._handleFinalResultPacket(packet);\n};\n\nQuery.prototype._handleFinalResultPacket = function(packet) {\n  if (packet.serverStatus & ServerStatus.SERVER_MORE_RESULTS_EXISTS) {\n    return;\n  }\n\n  var results = (this._results.length > 1)\n    ? this._results\n    : this._results[0];\n\n  var fields = (this._fields.length > 1)\n    ? this._fields\n    : this._fields[0];\n\n  this.end(this._loadError, results, fields);\n};\n\nQuery.prototype['RowDataPacket'] = function(packet, parser, connection) {\n  packet.parse(parser, this._resultSet.fieldPackets, this.typeCast, this.nestTables, connection);\n\n  if (this._callback) {\n    this._resultSet.rows.push(packet);\n  } else {\n    this.emit('result', packet, this._index);\n  }\n};\n\nQuery.prototype._sendLocalDataFile = function(path) {\n  var self = this;\n  var localStream = fs.createReadStream(path, {\n    flag      : 'r',\n    encoding  : null,\n    autoClose : true\n  });\n\n  this.on('pause', function () {\n    localStream.pause();\n  });\n\n  this.on('resume', function () {\n    localStream.resume();\n  });\n\n  localStream.on('data', function (data) {\n    self.emit('packet', new Packets.LocalDataFilePacket(data));\n  });\n\n  localStream.on('error', function (err) {\n    self._loadError = err;\n    localStream.emit('end');\n  });\n\n  localStream.on('end', function () {\n    self.emit('packet', new Packets.EmptyPacket());\n  });\n};\n\nQuery.prototype.stream = function(options) {\n  var self = this;\n\n  options = options || {};\n  options.objectMode = true;\n\n  var stream = new Readable(options);\n\n  stream._read = function() {\n    self._connection && self._connection.resume();\n  };\n\n  stream.once('end', function() {\n    process.nextTick(function () {\n      stream.emit('close');\n    });\n  });\n\n  this.on('result', function(row, i) {\n    if (!stream.push(row)) self._connection.pause();\n    stream.emit('result', row, i);  // replicate old emitter\n  });\n\n  this.on('error', function(err) {\n    stream.emit('error', err);  // Pass on any errors\n  });\n\n  this.on('end', function() {\n    stream.push(null);  // pushing null, indicating EOF\n  });\n\n  this.on('fields', function(fields, i) {\n    stream.emit('fields', fields, i);  // replicate old emitter\n  });\n\n  return stream;\n};\n"]},"metadata":{},"sourceType":"script"}