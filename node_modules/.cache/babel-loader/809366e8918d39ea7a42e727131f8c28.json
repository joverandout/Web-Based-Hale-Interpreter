{"ast":null,"code":"/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\nvar __decorate = this && this.__decorate || function (decorators, target, key, desc) {\n  var c = arguments.length,\n      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,\n      d;\n  if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n  return c > 3 && r && Object.defineProperty(target, key, r), r;\n};\n\nvar __param = this && this.__param || function (paramIndex, decorator) {\n  return function (target, key) {\n    decorator(target, key, paramIndex);\n  };\n};\n\nvar __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  function adopt(value) {\n    return value instanceof P ? value : new P(function (resolve) {\n      resolve(value);\n    });\n  }\n\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function step(result) {\n      result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);\n    }\n\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\n\nimport { equals } from '../../../../base/common/arrays.js';\nimport { CancellationTokenSource } from '../../../../base/common/cancellation.js';\nimport { onUnexpectedExternalError } from '../../../../base/common/errors.js';\nimport { Iterable } from '../../../../base/common/iterator.js';\nimport { LRUCache } from '../../../../base/common/map.js';\nimport { Position } from '../../../common/core/position.js';\nimport { Range } from '../../../common/core/range.js';\nimport { DocumentSymbolProviderRegistry } from '../../../common/languages.js';\nimport { ILanguageFeatureDebounceService } from '../../../common/services/languageFeatureDebounce.js';\nimport { createDecorator } from '../../../../platform/instantiation/common/instantiation.js';\nimport { registerSingleton } from '../../../../platform/instantiation/common/extensions.js';\nimport { IModelService } from '../../../common/services/model.js';\nimport { DisposableStore } from '../../../../base/common/lifecycle.js';\nexport class TreeElement {\n  remove() {\n    if (this.parent) {\n      this.parent.children.delete(this.id);\n    }\n  }\n\n  static findId(candidate, container) {\n    // complex id-computation which contains the origin/extension,\n    // the parent path, and some dedupe logic when names collide\n    let candidateId;\n\n    if (typeof candidate === 'string') {\n      candidateId = `${container.id}/${candidate}`;\n    } else {\n      candidateId = `${container.id}/${candidate.name}`;\n\n      if (container.children.get(candidateId) !== undefined) {\n        candidateId = `${container.id}/${candidate.name}_${candidate.range.startLineNumber}_${candidate.range.startColumn}`;\n      }\n    }\n\n    let id = candidateId;\n\n    for (let i = 0; container.children.get(id) !== undefined; i++) {\n      id = `${candidateId}_${i}`;\n    }\n\n    return id;\n  }\n\n  static empty(element) {\n    return element.children.size === 0;\n  }\n\n}\nexport class OutlineElement extends TreeElement {\n  constructor(id, parent, symbol) {\n    super();\n    this.id = id;\n    this.parent = parent;\n    this.symbol = symbol;\n    this.children = new Map();\n  }\n\n}\nexport class OutlineGroup extends TreeElement {\n  constructor(id, parent, label, order) {\n    super();\n    this.id = id;\n    this.parent = parent;\n    this.label = label;\n    this.order = order;\n    this.children = new Map();\n  }\n\n}\nexport class OutlineModel extends TreeElement {\n  constructor(uri) {\n    super();\n    this.uri = uri;\n    this.id = 'root';\n    this.parent = undefined;\n    this._groups = new Map();\n    this.children = new Map();\n    this.id = 'root';\n    this.parent = undefined;\n  }\n\n  static create(textModel, token) {\n    const cts = new CancellationTokenSource(token);\n    const result = new OutlineModel(textModel.uri);\n    const provider = DocumentSymbolProviderRegistry.ordered(textModel);\n    const promises = provider.map((provider, index) => {\n      var _a;\n\n      let id = TreeElement.findId(`provider_${index}`, result);\n      let group = new OutlineGroup(id, result, (_a = provider.displayName) !== null && _a !== void 0 ? _a : 'Unknown Outline Provider', index);\n      return Promise.resolve(provider.provideDocumentSymbols(textModel, cts.token)).then(result => {\n        for (const info of result || []) {\n          OutlineModel._makeOutlineElement(info, group);\n        }\n\n        return group;\n      }, err => {\n        onUnexpectedExternalError(err);\n        return group;\n      }).then(group => {\n        if (!TreeElement.empty(group)) {\n          result._groups.set(id, group);\n        } else {\n          group.remove();\n        }\n      });\n    });\n    const listener = DocumentSymbolProviderRegistry.onDidChange(() => {\n      const newProvider = DocumentSymbolProviderRegistry.ordered(textModel);\n\n      if (!equals(newProvider, provider)) {\n        cts.cancel();\n      }\n    });\n    return Promise.all(promises).then(() => {\n      if (cts.token.isCancellationRequested && !token.isCancellationRequested) {\n        return OutlineModel.create(textModel, token);\n      } else {\n        return result._compact();\n      }\n    }).finally(() => {\n      listener.dispose();\n    });\n  }\n\n  static _makeOutlineElement(info, container) {\n    let id = TreeElement.findId(info, container);\n    let res = new OutlineElement(id, container, info);\n\n    if (info.children) {\n      for (const childInfo of info.children) {\n        OutlineModel._makeOutlineElement(childInfo, res);\n      }\n    }\n\n    container.children.set(res.id, res);\n  }\n\n  _compact() {\n    let count = 0;\n\n    for (const [key, group] of this._groups) {\n      if (group.children.size === 0) {\n        // empty\n        this._groups.delete(key);\n      } else {\n        count += 1;\n      }\n    }\n\n    if (count !== 1) {\n      //\n      this.children = this._groups;\n    } else {\n      // adopt all elements of the first group\n      let group = Iterable.first(this._groups.values());\n\n      for (let [, child] of group.children) {\n        child.parent = this;\n        this.children.set(child.id, child);\n      }\n    }\n\n    return this;\n  }\n\n  getTopLevelSymbols() {\n    const roots = [];\n\n    for (const child of this.children.values()) {\n      if (child instanceof OutlineElement) {\n        roots.push(child.symbol);\n      } else {\n        roots.push(...Iterable.map(child.children.values(), child => child.symbol));\n      }\n    }\n\n    return roots.sort((a, b) => Range.compareRangesUsingStarts(a.range, b.range));\n  }\n\n  asListOfDocumentSymbols() {\n    const roots = this.getTopLevelSymbols();\n    const bucket = [];\n\n    OutlineModel._flattenDocumentSymbols(bucket, roots, '');\n\n    return bucket.sort((a, b) => Position.compare(Range.getStartPosition(a.range), Range.getStartPosition(b.range)) || Position.compare(Range.getEndPosition(b.range), Range.getEndPosition(a.range)));\n  }\n\n  static _flattenDocumentSymbols(bucket, entries, overrideContainerLabel) {\n    for (const entry of entries) {\n      bucket.push({\n        kind: entry.kind,\n        tags: entry.tags,\n        name: entry.name,\n        detail: entry.detail,\n        containerName: entry.containerName || overrideContainerLabel,\n        range: entry.range,\n        selectionRange: entry.selectionRange,\n        children: undefined // we flatten it...\n\n      }); // Recurse over children\n\n      if (entry.children) {\n        OutlineModel._flattenDocumentSymbols(bucket, entry.children, entry.name);\n      }\n    }\n  }\n\n}\nexport const IOutlineModelService = createDecorator('IOutlineModelService');\nlet OutlineModelService = class OutlineModelService {\n  constructor(debounces, modelService) {\n    this._disposables = new DisposableStore();\n    this._cache = new LRUCache(10, 0.7);\n    this._debounceInformation = debounces.for(DocumentSymbolProviderRegistry, 'DocumentSymbols', {\n      min: 350\n    }); // don't cache outline models longer than their text model\n\n    this._disposables.add(modelService.onModelRemoved(textModel => {\n      this._cache.delete(textModel.id);\n    }));\n  }\n\n  dispose() {\n    this._disposables.dispose();\n  }\n\n  getOrCreate(textModel, token) {\n    return __awaiter(this, void 0, void 0, function* () {\n      const provider = DocumentSymbolProviderRegistry.ordered(textModel);\n\n      let data = this._cache.get(textModel.id);\n\n      if (!data || data.versionId !== textModel.getVersionId() || !equals(data.provider, provider)) {\n        let source = new CancellationTokenSource();\n        data = {\n          versionId: textModel.getVersionId(),\n          provider,\n          promiseCnt: 0,\n          source,\n          promise: OutlineModel.create(textModel, source.token),\n          model: undefined\n        };\n\n        this._cache.set(textModel.id, data);\n\n        const now = Date.now();\n        data.promise.then(outlineModel => {\n          data.model = outlineModel;\n\n          this._debounceInformation.update(textModel, Date.now() - now);\n        }).catch(_err => {\n          this._cache.delete(textModel.id);\n        });\n      }\n\n      if (data.model) {\n        // resolved -> return data\n        return data.model;\n      } // increase usage counter\n\n\n      data.promiseCnt += 1;\n      const listener = token.onCancellationRequested(() => {\n        // last -> cancel provider request, remove cached promise\n        if (--data.promiseCnt === 0) {\n          data.source.cancel();\n\n          this._cache.delete(textModel.id);\n        }\n      });\n\n      try {\n        return yield data.promise;\n      } finally {\n        listener.dispose();\n      }\n    });\n  }\n\n};\nOutlineModelService = __decorate([__param(0, ILanguageFeatureDebounceService), __param(1, IModelService)], OutlineModelService);\nexport { OutlineModelService };\nregisterSingleton(IOutlineModelService, OutlineModelService, true);","map":{"version":3,"sources":["/home/joe/DISSY/flask_test_1/react-flask-app/node_modules/monaco-editor/esm/vs/editor/contrib/documentSymbols/browser/outlineModel.js"],"names":["__decorate","decorators","target","key","desc","c","arguments","length","r","Object","getOwnPropertyDescriptor","d","Reflect","decorate","i","defineProperty","__param","paramIndex","decorator","__awaiter","thisArg","_arguments","P","generator","adopt","value","resolve","Promise","reject","fulfilled","step","next","e","rejected","result","done","then","apply","equals","CancellationTokenSource","onUnexpectedExternalError","Iterable","LRUCache","Position","Range","DocumentSymbolProviderRegistry","ILanguageFeatureDebounceService","createDecorator","registerSingleton","IModelService","DisposableStore","TreeElement","remove","parent","children","delete","id","findId","candidate","container","candidateId","name","get","undefined","range","startLineNumber","startColumn","empty","element","size","OutlineElement","constructor","symbol","Map","OutlineGroup","label","order","OutlineModel","uri","_groups","create","textModel","token","cts","provider","ordered","promises","map","index","_a","group","displayName","provideDocumentSymbols","info","_makeOutlineElement","err","set","listener","onDidChange","newProvider","cancel","all","isCancellationRequested","_compact","finally","dispose","res","childInfo","count","first","values","child","getTopLevelSymbols","roots","push","sort","a","b","compareRangesUsingStarts","asListOfDocumentSymbols","bucket","_flattenDocumentSymbols","compare","getStartPosition","getEndPosition","entries","overrideContainerLabel","entry","kind","tags","detail","containerName","selectionRange","IOutlineModelService","OutlineModelService","debounces","modelService","_disposables","_cache","_debounceInformation","for","min","add","onModelRemoved","getOrCreate","data","versionId","getVersionId","source","promiseCnt","promise","model","now","Date","outlineModel","update","catch","_err","onCancellationRequested"],"mappings":"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","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\nvar __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {\n    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;\n    if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);\n    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n    return c > 3 && r && Object.defineProperty(target, key, r), r;\n};\nvar __param = (this && this.__param) || function (paramIndex, decorator) {\n    return function (target, key) { decorator(target, key, paramIndex); }\n};\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nimport { equals } from '../../../../base/common/arrays.js';\nimport { CancellationTokenSource } from '../../../../base/common/cancellation.js';\nimport { onUnexpectedExternalError } from '../../../../base/common/errors.js';\nimport { Iterable } from '../../../../base/common/iterator.js';\nimport { LRUCache } from '../../../../base/common/map.js';\nimport { Position } from '../../../common/core/position.js';\nimport { Range } from '../../../common/core/range.js';\nimport { DocumentSymbolProviderRegistry } from '../../../common/languages.js';\nimport { ILanguageFeatureDebounceService } from '../../../common/services/languageFeatureDebounce.js';\nimport { createDecorator } from '../../../../platform/instantiation/common/instantiation.js';\nimport { registerSingleton } from '../../../../platform/instantiation/common/extensions.js';\nimport { IModelService } from '../../../common/services/model.js';\nimport { DisposableStore } from '../../../../base/common/lifecycle.js';\nexport class TreeElement {\n    remove() {\n        if (this.parent) {\n            this.parent.children.delete(this.id);\n        }\n    }\n    static findId(candidate, container) {\n        // complex id-computation which contains the origin/extension,\n        // the parent path, and some dedupe logic when names collide\n        let candidateId;\n        if (typeof candidate === 'string') {\n            candidateId = `${container.id}/${candidate}`;\n        }\n        else {\n            candidateId = `${container.id}/${candidate.name}`;\n            if (container.children.get(candidateId) !== undefined) {\n                candidateId = `${container.id}/${candidate.name}_${candidate.range.startLineNumber}_${candidate.range.startColumn}`;\n            }\n        }\n        let id = candidateId;\n        for (let i = 0; container.children.get(id) !== undefined; i++) {\n            id = `${candidateId}_${i}`;\n        }\n        return id;\n    }\n    static empty(element) {\n        return element.children.size === 0;\n    }\n}\nexport class OutlineElement extends TreeElement {\n    constructor(id, parent, symbol) {\n        super();\n        this.id = id;\n        this.parent = parent;\n        this.symbol = symbol;\n        this.children = new Map();\n    }\n}\nexport class OutlineGroup extends TreeElement {\n    constructor(id, parent, label, order) {\n        super();\n        this.id = id;\n        this.parent = parent;\n        this.label = label;\n        this.order = order;\n        this.children = new Map();\n    }\n}\nexport class OutlineModel extends TreeElement {\n    constructor(uri) {\n        super();\n        this.uri = uri;\n        this.id = 'root';\n        this.parent = undefined;\n        this._groups = new Map();\n        this.children = new Map();\n        this.id = 'root';\n        this.parent = undefined;\n    }\n    static create(textModel, token) {\n        const cts = new CancellationTokenSource(token);\n        const result = new OutlineModel(textModel.uri);\n        const provider = DocumentSymbolProviderRegistry.ordered(textModel);\n        const promises = provider.map((provider, index) => {\n            var _a;\n            let id = TreeElement.findId(`provider_${index}`, result);\n            let group = new OutlineGroup(id, result, (_a = provider.displayName) !== null && _a !== void 0 ? _a : 'Unknown Outline Provider', index);\n            return Promise.resolve(provider.provideDocumentSymbols(textModel, cts.token)).then(result => {\n                for (const info of result || []) {\n                    OutlineModel._makeOutlineElement(info, group);\n                }\n                return group;\n            }, err => {\n                onUnexpectedExternalError(err);\n                return group;\n            }).then(group => {\n                if (!TreeElement.empty(group)) {\n                    result._groups.set(id, group);\n                }\n                else {\n                    group.remove();\n                }\n            });\n        });\n        const listener = DocumentSymbolProviderRegistry.onDidChange(() => {\n            const newProvider = DocumentSymbolProviderRegistry.ordered(textModel);\n            if (!equals(newProvider, provider)) {\n                cts.cancel();\n            }\n        });\n        return Promise.all(promises).then(() => {\n            if (cts.token.isCancellationRequested && !token.isCancellationRequested) {\n                return OutlineModel.create(textModel, token);\n            }\n            else {\n                return result._compact();\n            }\n        }).finally(() => {\n            listener.dispose();\n        });\n    }\n    static _makeOutlineElement(info, container) {\n        let id = TreeElement.findId(info, container);\n        let res = new OutlineElement(id, container, info);\n        if (info.children) {\n            for (const childInfo of info.children) {\n                OutlineModel._makeOutlineElement(childInfo, res);\n            }\n        }\n        container.children.set(res.id, res);\n    }\n    _compact() {\n        let count = 0;\n        for (const [key, group] of this._groups) {\n            if (group.children.size === 0) { // empty\n                this._groups.delete(key);\n            }\n            else {\n                count += 1;\n            }\n        }\n        if (count !== 1) {\n            //\n            this.children = this._groups;\n        }\n        else {\n            // adopt all elements of the first group\n            let group = Iterable.first(this._groups.values());\n            for (let [, child] of group.children) {\n                child.parent = this;\n                this.children.set(child.id, child);\n            }\n        }\n        return this;\n    }\n    getTopLevelSymbols() {\n        const roots = [];\n        for (const child of this.children.values()) {\n            if (child instanceof OutlineElement) {\n                roots.push(child.symbol);\n            }\n            else {\n                roots.push(...Iterable.map(child.children.values(), child => child.symbol));\n            }\n        }\n        return roots.sort((a, b) => Range.compareRangesUsingStarts(a.range, b.range));\n    }\n    asListOfDocumentSymbols() {\n        const roots = this.getTopLevelSymbols();\n        const bucket = [];\n        OutlineModel._flattenDocumentSymbols(bucket, roots, '');\n        return bucket.sort((a, b) => Position.compare(Range.getStartPosition(a.range), Range.getStartPosition(b.range)) || Position.compare(Range.getEndPosition(b.range), Range.getEndPosition(a.range)));\n    }\n    static _flattenDocumentSymbols(bucket, entries, overrideContainerLabel) {\n        for (const entry of entries) {\n            bucket.push({\n                kind: entry.kind,\n                tags: entry.tags,\n                name: entry.name,\n                detail: entry.detail,\n                containerName: entry.containerName || overrideContainerLabel,\n                range: entry.range,\n                selectionRange: entry.selectionRange,\n                children: undefined, // we flatten it...\n            });\n            // Recurse over children\n            if (entry.children) {\n                OutlineModel._flattenDocumentSymbols(bucket, entry.children, entry.name);\n            }\n        }\n    }\n}\nexport const IOutlineModelService = createDecorator('IOutlineModelService');\nlet OutlineModelService = class OutlineModelService {\n    constructor(debounces, modelService) {\n        this._disposables = new DisposableStore();\n        this._cache = new LRUCache(10, 0.7);\n        this._debounceInformation = debounces.for(DocumentSymbolProviderRegistry, 'DocumentSymbols', { min: 350 });\n        // don't cache outline models longer than their text model\n        this._disposables.add(modelService.onModelRemoved(textModel => {\n            this._cache.delete(textModel.id);\n        }));\n    }\n    dispose() {\n        this._disposables.dispose();\n    }\n    getOrCreate(textModel, token) {\n        return __awaiter(this, void 0, void 0, function* () {\n            const provider = DocumentSymbolProviderRegistry.ordered(textModel);\n            let data = this._cache.get(textModel.id);\n            if (!data || data.versionId !== textModel.getVersionId() || !equals(data.provider, provider)) {\n                let source = new CancellationTokenSource();\n                data = {\n                    versionId: textModel.getVersionId(),\n                    provider,\n                    promiseCnt: 0,\n                    source,\n                    promise: OutlineModel.create(textModel, source.token),\n                    model: undefined,\n                };\n                this._cache.set(textModel.id, data);\n                const now = Date.now();\n                data.promise.then(outlineModel => {\n                    data.model = outlineModel;\n                    this._debounceInformation.update(textModel, Date.now() - now);\n                }).catch(_err => {\n                    this._cache.delete(textModel.id);\n                });\n            }\n            if (data.model) {\n                // resolved -> return data\n                return data.model;\n            }\n            // increase usage counter\n            data.promiseCnt += 1;\n            const listener = token.onCancellationRequested(() => {\n                // last -> cancel provider request, remove cached promise\n                if (--data.promiseCnt === 0) {\n                    data.source.cancel();\n                    this._cache.delete(textModel.id);\n                }\n            });\n            try {\n                return yield data.promise;\n            }\n            finally {\n                listener.dispose();\n            }\n        });\n    }\n};\nOutlineModelService = __decorate([\n    __param(0, ILanguageFeatureDebounceService),\n    __param(1, IModelService)\n], OutlineModelService);\nexport { OutlineModelService };\nregisterSingleton(IOutlineModelService, OutlineModelService, true);\n"]},"metadata":{},"sourceType":"module"}