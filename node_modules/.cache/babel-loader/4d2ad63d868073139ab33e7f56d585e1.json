{"ast":null,"code":"/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\nvar __decorate = this && this.__decorate || function (decorators, target, key, desc) {\n  var c = arguments.length,\n      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,\n      d;\n  if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n  return c > 3 && r && Object.defineProperty(target, key, r), r;\n};\n\nvar __param = this && this.__param || function (paramIndex, decorator) {\n  return function (target, key) {\n    decorator(target, key, paramIndex);\n  };\n};\n\nimport { createCancelablePromise, TimeoutTimer } from '../../../../base/common/async.js';\nimport { RGBA } from '../../../../base/common/color.js';\nimport { onUnexpectedError } from '../../../../base/common/errors.js';\nimport { Disposable, DisposableStore } from '../../../../base/common/lifecycle.js';\nimport { noBreakWhitespace } from '../../../../base/common/strings.js';\nimport { DynamicCssRules } from '../../../browser/editorDom.js';\nimport { registerEditorContribution } from '../../../browser/editorExtensions.js';\nimport { Range } from '../../../common/core/range.js';\nimport { ModelDecorationOptions } from '../../../common/model/textModel.js';\nimport { ColorProviderRegistry } from '../../../common/languages.js';\nimport { getColors } from './color.js';\nimport { IConfigurationService } from '../../../../platform/configuration/common/configuration.js';\nexport const ColorDecorationInjectedTextMarker = Object.create({});\nconst MAX_DECORATORS = 500;\nlet ColorDetector = class ColorDetector extends Disposable {\n  constructor(_editor, _configurationService) {\n    super();\n    this._editor = _editor;\n    this._configurationService = _configurationService;\n    this._localToDispose = this._register(new DisposableStore());\n    this._decorationsIds = [];\n    this._colorDatas = new Map();\n    this._colorDecoratorIds = new Set();\n    this._ruleFactory = new DynamicCssRules(this._editor);\n    this._colorDecorationClassRefs = this._register(new DisposableStore());\n\n    this._register(_editor.onDidChangeModel(() => {\n      this._isEnabled = this.isEnabled();\n      this.onModelChanged();\n    }));\n\n    this._register(_editor.onDidChangeModelLanguage(() => this.onModelChanged()));\n\n    this._register(ColorProviderRegistry.onDidChange(() => this.onModelChanged()));\n\n    this._register(_editor.onDidChangeConfiguration(() => {\n      let prevIsEnabled = this._isEnabled;\n      this._isEnabled = this.isEnabled();\n\n      if (prevIsEnabled !== this._isEnabled) {\n        if (this._isEnabled) {\n          this.onModelChanged();\n        } else {\n          this.removeAllDecorations();\n        }\n      }\n    }));\n\n    this._timeoutTimer = null;\n    this._computePromise = null;\n    this._isEnabled = this.isEnabled();\n    this.onModelChanged();\n  }\n\n  isEnabled() {\n    const model = this._editor.getModel();\n\n    if (!model) {\n      return false;\n    }\n\n    const languageId = model.getLanguageId(); // handle deprecated settings. [languageId].colorDecorators.enable\n\n    const deprecatedConfig = this._configurationService.getValue(languageId);\n\n    if (deprecatedConfig && typeof deprecatedConfig === 'object') {\n      const colorDecorators = deprecatedConfig['colorDecorators']; // deprecatedConfig.valueOf('.colorDecorators.enable');\n\n      if (colorDecorators && colorDecorators['enable'] !== undefined && !colorDecorators['enable']) {\n        return colorDecorators['enable'];\n      }\n    }\n\n    return this._editor.getOption(17\n    /* colorDecorators */\n    );\n  }\n\n  static get(editor) {\n    return editor.getContribution(this.ID);\n  }\n\n  dispose() {\n    this.stop();\n    this.removeAllDecorations();\n    super.dispose();\n  }\n\n  onModelChanged() {\n    this.stop();\n\n    if (!this._isEnabled) {\n      return;\n    }\n\n    const model = this._editor.getModel();\n\n    if (!model || !ColorProviderRegistry.has(model)) {\n      return;\n    }\n\n    this._localToDispose.add(this._editor.onDidChangeModelContent(() => {\n      if (!this._timeoutTimer) {\n        this._timeoutTimer = new TimeoutTimer();\n\n        this._timeoutTimer.cancelAndSet(() => {\n          this._timeoutTimer = null;\n          this.beginCompute();\n        }, ColorDetector.RECOMPUTE_TIME);\n      }\n    }));\n\n    this.beginCompute();\n  }\n\n  beginCompute() {\n    this._computePromise = createCancelablePromise(token => {\n      const model = this._editor.getModel();\n\n      if (!model) {\n        return Promise.resolve([]);\n      }\n\n      return getColors(model, token);\n    });\n\n    this._computePromise.then(colorInfos => {\n      this.updateDecorations(colorInfos);\n      this.updateColorDecorators(colorInfos);\n      this._computePromise = null;\n    }, onUnexpectedError);\n  }\n\n  stop() {\n    if (this._timeoutTimer) {\n      this._timeoutTimer.cancel();\n\n      this._timeoutTimer = null;\n    }\n\n    if (this._computePromise) {\n      this._computePromise.cancel();\n\n      this._computePromise = null;\n    }\n\n    this._localToDispose.clear();\n  }\n\n  updateDecorations(colorDatas) {\n    const decorations = colorDatas.map(c => ({\n      range: {\n        startLineNumber: c.colorInfo.range.startLineNumber,\n        startColumn: c.colorInfo.range.startColumn,\n        endLineNumber: c.colorInfo.range.endLineNumber,\n        endColumn: c.colorInfo.range.endColumn\n      },\n      options: ModelDecorationOptions.EMPTY\n    }));\n    this._decorationsIds = this._editor.deltaDecorations(this._decorationsIds, decorations);\n    this._colorDatas = new Map();\n\n    this._decorationsIds.forEach((id, i) => this._colorDatas.set(id, colorDatas[i]));\n  }\n\n  updateColorDecorators(colorData) {\n    this._colorDecorationClassRefs.clear();\n\n    let decorations = [];\n\n    for (let i = 0; i < colorData.length && decorations.length < MAX_DECORATORS; i++) {\n      const {\n        red,\n        green,\n        blue,\n        alpha\n      } = colorData[i].colorInfo.color;\n      const rgba = new RGBA(Math.round(red * 255), Math.round(green * 255), Math.round(blue * 255), alpha);\n      let color = `rgba(${rgba.r}, ${rgba.g}, ${rgba.b}, ${rgba.a})`;\n\n      const ref = this._colorDecorationClassRefs.add(this._ruleFactory.createClassNameRef({\n        backgroundColor: color\n      }));\n\n      decorations.push({\n        range: {\n          startLineNumber: colorData[i].colorInfo.range.startLineNumber,\n          startColumn: colorData[i].colorInfo.range.startColumn,\n          endLineNumber: colorData[i].colorInfo.range.endLineNumber,\n          endColumn: colorData[i].colorInfo.range.endColumn\n        },\n        options: {\n          description: 'colorDetector',\n          before: {\n            content: noBreakWhitespace,\n            inlineClassName: `${ref.className} colorpicker-color-decoration`,\n            inlineClassNameAffectsLetterSpacing: true,\n            attachedData: ColorDecorationInjectedTextMarker\n          }\n        }\n      });\n    }\n\n    this._colorDecoratorIds = new Set(this._editor.deltaDecorations([...this._colorDecoratorIds], decorations));\n  }\n\n  removeAllDecorations() {\n    this._decorationsIds = this._editor.deltaDecorations(this._decorationsIds, []);\n    this._colorDecoratorIds = new Set(this._editor.deltaDecorations([...this._colorDecoratorIds], []));\n\n    this._colorDecorationClassRefs.clear();\n  }\n\n  getColorData(position) {\n    const model = this._editor.getModel();\n\n    if (!model) {\n      return null;\n    }\n\n    const decorations = model.getDecorationsInRange(Range.fromPositions(position, position)).filter(d => this._colorDatas.has(d.id));\n\n    if (decorations.length === 0) {\n      return null;\n    }\n\n    return this._colorDatas.get(decorations[0].id);\n  }\n\n  isColorDecorationId(decorationId) {\n    return this._colorDecoratorIds.has(decorationId);\n  }\n\n};\nColorDetector.ID = 'editor.contrib.colorDetector';\nColorDetector.RECOMPUTE_TIME = 1000; // ms\n\nColorDetector = __decorate([__param(1, IConfigurationService)], ColorDetector);\nexport { ColorDetector };\nregisterEditorContribution(ColorDetector.ID, ColorDetector);","map":{"version":3,"sources":["/home/joe/DISSY/flask_test_1/react-flask-app/node_modules/monaco-editor/esm/vs/editor/contrib/colorPicker/browser/colorDetector.js"],"names":["__decorate","decorators","target","key","desc","c","arguments","length","r","Object","getOwnPropertyDescriptor","d","Reflect","decorate","i","defineProperty","__param","paramIndex","decorator","createCancelablePromise","TimeoutTimer","RGBA","onUnexpectedError","Disposable","DisposableStore","noBreakWhitespace","DynamicCssRules","registerEditorContribution","Range","ModelDecorationOptions","ColorProviderRegistry","getColors","IConfigurationService","ColorDecorationInjectedTextMarker","create","MAX_DECORATORS","ColorDetector","constructor","_editor","_configurationService","_localToDispose","_register","_decorationsIds","_colorDatas","Map","_colorDecoratorIds","Set","_ruleFactory","_colorDecorationClassRefs","onDidChangeModel","_isEnabled","isEnabled","onModelChanged","onDidChangeModelLanguage","onDidChange","onDidChangeConfiguration","prevIsEnabled","removeAllDecorations","_timeoutTimer","_computePromise","model","getModel","languageId","getLanguageId","deprecatedConfig","getValue","colorDecorators","undefined","getOption","get","editor","getContribution","ID","dispose","stop","has","add","onDidChangeModelContent","cancelAndSet","beginCompute","RECOMPUTE_TIME","token","Promise","resolve","then","colorInfos","updateDecorations","updateColorDecorators","cancel","clear","colorDatas","decorations","map","range","startLineNumber","colorInfo","startColumn","endLineNumber","endColumn","options","EMPTY","deltaDecorations","forEach","id","set","colorData","red","green","blue","alpha","color","rgba","Math","round","g","b","a","ref","createClassNameRef","backgroundColor","push","description","before","content","inlineClassName","className","inlineClassNameAffectsLetterSpacing","attachedData","getColorData","position","getDecorationsInRange","fromPositions","filter","isColorDecorationId","decorationId"],"mappings":"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","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\nvar __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {\n    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;\n    if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);\n    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n    return c > 3 && r && Object.defineProperty(target, key, r), r;\n};\nvar __param = (this && this.__param) || function (paramIndex, decorator) {\n    return function (target, key) { decorator(target, key, paramIndex); }\n};\nimport { createCancelablePromise, TimeoutTimer } from '../../../../base/common/async.js';\nimport { RGBA } from '../../../../base/common/color.js';\nimport { onUnexpectedError } from '../../../../base/common/errors.js';\nimport { Disposable, DisposableStore } from '../../../../base/common/lifecycle.js';\nimport { noBreakWhitespace } from '../../../../base/common/strings.js';\nimport { DynamicCssRules } from '../../../browser/editorDom.js';\nimport { registerEditorContribution } from '../../../browser/editorExtensions.js';\nimport { Range } from '../../../common/core/range.js';\nimport { ModelDecorationOptions } from '../../../common/model/textModel.js';\nimport { ColorProviderRegistry } from '../../../common/languages.js';\nimport { getColors } from './color.js';\nimport { IConfigurationService } from '../../../../platform/configuration/common/configuration.js';\nexport const ColorDecorationInjectedTextMarker = Object.create({});\nconst MAX_DECORATORS = 500;\nlet ColorDetector = class ColorDetector extends Disposable {\n    constructor(_editor, _configurationService) {\n        super();\n        this._editor = _editor;\n        this._configurationService = _configurationService;\n        this._localToDispose = this._register(new DisposableStore());\n        this._decorationsIds = [];\n        this._colorDatas = new Map();\n        this._colorDecoratorIds = new Set();\n        this._ruleFactory = new DynamicCssRules(this._editor);\n        this._colorDecorationClassRefs = this._register(new DisposableStore());\n        this._register(_editor.onDidChangeModel(() => {\n            this._isEnabled = this.isEnabled();\n            this.onModelChanged();\n        }));\n        this._register(_editor.onDidChangeModelLanguage(() => this.onModelChanged()));\n        this._register(ColorProviderRegistry.onDidChange(() => this.onModelChanged()));\n        this._register(_editor.onDidChangeConfiguration(() => {\n            let prevIsEnabled = this._isEnabled;\n            this._isEnabled = this.isEnabled();\n            if (prevIsEnabled !== this._isEnabled) {\n                if (this._isEnabled) {\n                    this.onModelChanged();\n                }\n                else {\n                    this.removeAllDecorations();\n                }\n            }\n        }));\n        this._timeoutTimer = null;\n        this._computePromise = null;\n        this._isEnabled = this.isEnabled();\n        this.onModelChanged();\n    }\n    isEnabled() {\n        const model = this._editor.getModel();\n        if (!model) {\n            return false;\n        }\n        const languageId = model.getLanguageId();\n        // handle deprecated settings. [languageId].colorDecorators.enable\n        const deprecatedConfig = this._configurationService.getValue(languageId);\n        if (deprecatedConfig && typeof deprecatedConfig === 'object') {\n            const colorDecorators = deprecatedConfig['colorDecorators']; // deprecatedConfig.valueOf('.colorDecorators.enable');\n            if (colorDecorators && colorDecorators['enable'] !== undefined && !colorDecorators['enable']) {\n                return colorDecorators['enable'];\n            }\n        }\n        return this._editor.getOption(17 /* colorDecorators */);\n    }\n    static get(editor) {\n        return editor.getContribution(this.ID);\n    }\n    dispose() {\n        this.stop();\n        this.removeAllDecorations();\n        super.dispose();\n    }\n    onModelChanged() {\n        this.stop();\n        if (!this._isEnabled) {\n            return;\n        }\n        const model = this._editor.getModel();\n        if (!model || !ColorProviderRegistry.has(model)) {\n            return;\n        }\n        this._localToDispose.add(this._editor.onDidChangeModelContent(() => {\n            if (!this._timeoutTimer) {\n                this._timeoutTimer = new TimeoutTimer();\n                this._timeoutTimer.cancelAndSet(() => {\n                    this._timeoutTimer = null;\n                    this.beginCompute();\n                }, ColorDetector.RECOMPUTE_TIME);\n            }\n        }));\n        this.beginCompute();\n    }\n    beginCompute() {\n        this._computePromise = createCancelablePromise(token => {\n            const model = this._editor.getModel();\n            if (!model) {\n                return Promise.resolve([]);\n            }\n            return getColors(model, token);\n        });\n        this._computePromise.then((colorInfos) => {\n            this.updateDecorations(colorInfos);\n            this.updateColorDecorators(colorInfos);\n            this._computePromise = null;\n        }, onUnexpectedError);\n    }\n    stop() {\n        if (this._timeoutTimer) {\n            this._timeoutTimer.cancel();\n            this._timeoutTimer = null;\n        }\n        if (this._computePromise) {\n            this._computePromise.cancel();\n            this._computePromise = null;\n        }\n        this._localToDispose.clear();\n    }\n    updateDecorations(colorDatas) {\n        const decorations = colorDatas.map(c => ({\n            range: {\n                startLineNumber: c.colorInfo.range.startLineNumber,\n                startColumn: c.colorInfo.range.startColumn,\n                endLineNumber: c.colorInfo.range.endLineNumber,\n                endColumn: c.colorInfo.range.endColumn\n            },\n            options: ModelDecorationOptions.EMPTY\n        }));\n        this._decorationsIds = this._editor.deltaDecorations(this._decorationsIds, decorations);\n        this._colorDatas = new Map();\n        this._decorationsIds.forEach((id, i) => this._colorDatas.set(id, colorDatas[i]));\n    }\n    updateColorDecorators(colorData) {\n        this._colorDecorationClassRefs.clear();\n        let decorations = [];\n        for (let i = 0; i < colorData.length && decorations.length < MAX_DECORATORS; i++) {\n            const { red, green, blue, alpha } = colorData[i].colorInfo.color;\n            const rgba = new RGBA(Math.round(red * 255), Math.round(green * 255), Math.round(blue * 255), alpha);\n            let color = `rgba(${rgba.r}, ${rgba.g}, ${rgba.b}, ${rgba.a})`;\n            const ref = this._colorDecorationClassRefs.add(this._ruleFactory.createClassNameRef({\n                backgroundColor: color\n            }));\n            decorations.push({\n                range: {\n                    startLineNumber: colorData[i].colorInfo.range.startLineNumber,\n                    startColumn: colorData[i].colorInfo.range.startColumn,\n                    endLineNumber: colorData[i].colorInfo.range.endLineNumber,\n                    endColumn: colorData[i].colorInfo.range.endColumn\n                },\n                options: {\n                    description: 'colorDetector',\n                    before: {\n                        content: noBreakWhitespace,\n                        inlineClassName: `${ref.className} colorpicker-color-decoration`,\n                        inlineClassNameAffectsLetterSpacing: true,\n                        attachedData: ColorDecorationInjectedTextMarker\n                    }\n                }\n            });\n        }\n        this._colorDecoratorIds = new Set(this._editor.deltaDecorations([...this._colorDecoratorIds], decorations));\n    }\n    removeAllDecorations() {\n        this._decorationsIds = this._editor.deltaDecorations(this._decorationsIds, []);\n        this._colorDecoratorIds = new Set(this._editor.deltaDecorations([...this._colorDecoratorIds], []));\n        this._colorDecorationClassRefs.clear();\n    }\n    getColorData(position) {\n        const model = this._editor.getModel();\n        if (!model) {\n            return null;\n        }\n        const decorations = model\n            .getDecorationsInRange(Range.fromPositions(position, position))\n            .filter(d => this._colorDatas.has(d.id));\n        if (decorations.length === 0) {\n            return null;\n        }\n        return this._colorDatas.get(decorations[0].id);\n    }\n    isColorDecorationId(decorationId) {\n        return this._colorDecoratorIds.has(decorationId);\n    }\n};\nColorDetector.ID = 'editor.contrib.colorDetector';\nColorDetector.RECOMPUTE_TIME = 1000; // ms\nColorDetector = __decorate([\n    __param(1, IConfigurationService)\n], ColorDetector);\nexport { ColorDetector };\nregisterEditorContribution(ColorDetector.ID, ColorDetector);\n"]},"metadata":{},"sourceType":"module"}